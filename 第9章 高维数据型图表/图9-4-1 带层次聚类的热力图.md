# 图9-4-1 带层次聚类的热力图

```python
import matplotlib.pyplot as plt
import pandas as pd
import seaborn as sns
from plotnine.data import mtcars
from sklearn.preprocessing import scale

sns.set_style("white")
sns.set_context("notebook", font_scale=1.5,
                rc={'axes.labelsize': 17, 'legend.fontsize': 17,
                    'xtick.labelsize': 15, 'ytick.labelsize': 10})

df = mtcars.set_index('name')
df.loc[:, :] = scale(df.values)
df

```
```
                          mpg       cyl      disp        hp      drat  \
name                                                                    
Mazda RX4            0.153299 -0.106668 -0.579750 -0.543655  0.576594   
Mazda RX4 Wag        0.153299 -0.106668 -0.579750 -0.543655  0.576594   
Datsun 710           0.456737 -1.244457 -1.006026 -0.795570  0.481584   
Hornet 4 Drive       0.220730 -0.106668  0.223615 -0.543655 -0.981576   
Hornet Sportabout   -0.234427  1.031121  1.059772  0.419550 -0.848562   
Valiant             -0.335572 -0.106668 -0.046906 -0.617748 -1.589643   
Duster 360          -0.976163  1.031121  1.059772  1.456847 -0.734549   
Merc 240D            0.726459 -1.244457 -0.688779 -1.254944  0.177551   
Merc 230             0.456737 -1.244457 -0.737144 -0.765933  0.614599   
Merc 280            -0.150138 -0.106668 -0.517448 -0.351014  0.614599   
Merc 280C           -0.386145 -0.106668 -0.517448 -0.351014  0.614599   
Merc 450SE          -0.622152  1.031121  0.369533  0.493642 -1.000578   
Merc 450SL          -0.470433  1.031121  0.369533  0.493642 -1.000578   
Merc 450SLC         -0.824444  1.031121  0.369533  0.493642 -1.000578   
Cadillac Fleetwood  -1.633610  1.031121  1.977904  0.864106 -1.266608   
Lincoln Continental -1.633610  1.031121  1.879533  1.012291 -1.133593   
Chrysler Imperial   -0.908732  1.031121  1.715580  1.234569 -0.696545   
Fiat 128             2.075070 -1.244457 -1.246216 -1.195670  0.918632   
Honda Civic          1.737917 -1.244457 -1.270809 -1.403130  2.533809   
Toyota Corolla       2.327934 -1.244457 -1.308518 -1.210489  1.184661   
Toyota Corona        0.237587 -1.244457 -0.906835 -0.736296  0.196553   
Dodge Challenger    -0.773871  1.031121  0.715472  0.049086 -1.589643   
AMC Javelin         -0.824444  1.031121  0.600705  0.049086 -0.848562   
Camaro Z28          -1.144739  1.031121  0.977795  1.456847  0.253559   
Pontiac Firebird    -0.150138  1.031121  1.387676  0.419550 -0.981576   
Fiat X1-9            1.215330 -1.244457 -1.243757 -1.195670  0.918632   
Porsche 914-2        0.996181 -1.244457 -0.905195 -0.825207  1.583705   
Lotus Europa         1.737917 -1.244457 -1.111775 -0.499199  0.329567   
Ford Pantera L      -0.723298  1.031121  0.985993  1.738399  1.184661   
Ferrari Dino        -0.065850 -0.106668 -0.702714  0.419550  0.044536   
Maserati Bora       -0.858159  1.031121  0.576113  2.790515 -0.107481   
Volvo 142E           0.220730 -1.244457 -0.899457 -0.558473  0.975638   

                           wt      qsec        vs        am      gear  \
name                                                                    
Mazda RX4           -0.620167 -0.789601 -0.881917  1.208941  0.430331   
Mazda RX4 Wag       -0.355382 -0.471202 -0.881917  1.208941  0.430331   
Datsun 710          -0.931678  0.432823  1.133893  1.208941  0.430331   
Hornet 4 Drive      -0.002336  0.904736  1.133893 -0.827170 -0.946729   
Hornet Sportabout    0.231297 -0.471202 -0.881917 -0.827170 -0.946729   
Valiant              0.252064  1.348220  1.133893 -0.827170 -0.946729   
Duster 360           0.366285 -1.142114 -0.881917 -0.827170 -0.946729   
Merc 240D           -0.028296  1.223135  1.133893 -0.827170  0.430331   
Merc 230            -0.069830  2.871986  1.133893 -0.827170  0.430331   
Merc 280             0.231297  0.256567  1.133893 -0.827170  0.430331   
Merc 280C            0.231297  0.597708  1.133893 -0.827170  0.430331   
Merc 450SE           0.885470 -0.255145 -0.881917 -0.827170 -0.946729   
Merc 450SL           0.532424 -0.141432 -0.881917 -0.827170 -0.946729   
Merc 450SLC          0.584343  0.085996 -0.881917 -0.827170 -0.946729   
Cadillac Fleetwood   2.110747  0.074625 -0.881917 -0.827170 -0.946729   
Lincoln Continental  2.291423 -0.016346 -0.881917 -0.827170 -0.946729   
Chrysler Imperial    2.209392 -0.243774 -0.881917 -0.827170 -0.946729   
Fiat 128            -1.056282  0.921793  1.133893  1.208941  0.430331   
Honda Civic         -1.663729  0.381652  1.133893  1.208941  0.430331   
Toyota Corolla      -1.435287  1.166278  1.133893  1.208941  0.430331   
Toyota Corona       -0.781114  1.228820  1.133893 -0.827170 -0.946729   
Dodge Challenger     0.314367 -0.556487 -0.881917 -0.827170 -0.946729   
AMC Javelin          0.226105 -0.312002 -0.881917 -0.827170 -0.946729   
Camaro Z28           0.646645 -1.386598 -0.881917 -0.827170 -0.946729   
Pontiac Firebird     0.651837 -0.454145 -0.881917 -0.827170 -0.946729   
Fiat X1-9           -1.331450  0.597708  1.133893  1.208941  0.430331   
Porsche 914-2       -1.118584 -0.653144 -0.881917  1.208941  1.807392   
Lotus Europa        -1.769642 -0.539430  1.133893  1.208941  1.807392   
Ford Pantera L      -0.049063 -1.903996 -0.881917  1.208941  1.807392   
Ferrari Dino        -0.464411 -1.335427 -0.881917  1.208941  1.807392   
Maserati Bora        0.366285 -1.847139 -0.881917  1.208941  1.807392   
Volvo 142E          -0.454027  0.427138  1.133893  1.208941  0.430331   

                         carb  
name                           
Mazda RX4            0.746967  
Mazda RX4 Wag        0.746967  
Datsun 710          -1.140108  
Hornet 4 Drive      -1.140108  
Hornet Sportabout   -0.511083  
Valiant             -1.140108  
Duster 360           0.746967  
Merc 240D           -0.511083  
Merc 230            -0.511083  
Merc 280             0.746967  
Merc 280C            0.746967  
Merc 450SE           0.117942  
Merc 450SL           0.117942  
Merc 450SLC          0.117942  
Cadillac Fleetwood   0.746967  
Lincoln Continental  0.746967  
Chrysler Imperial    0.746967  
Fiat 128            -1.140108  
Honda Civic         -0.511083  
Toyota Corolla      -1.140108  
Toyota Corona       -1.140108  
Dodge Challenger    -0.511083  
AMC Javelin         -0.511083  
Camaro Z28           0.746967  
Pontiac Firebird    -0.511083  
Fiat X1-9           -1.140108  
Porsche 914-2       -0.511083  
Lotus Europa        -0.511083  
Ford Pantera L       0.746967  
Ferrari Dino         2.005017  
Maserati Bora        3.263067  
Volvo 142E          -0.511083  
```
##  (a)热力图

```python
fig = plt.figure(figsize=(7, 7), dpi=80)
sns.heatmap(df, center=0, cmap="RdYlBu_r",
            linewidths=.15, linecolor='k')
# sns.set()
plt.show()
# plt.savefig('heatmap2.pdf')

```
```
<Figure size 560x560 with 2 Axes>
```
## (b)带层次聚类的热力图

```python
sns.clustermap(df, center=0, cmap="RdYlBu_r",
               linewidths=.15, linecolor='k', figsize=(8, 8))
# plt.savefig('heatmap1.pdf')

```
```
<seaborn.matrix.ClusterGrid at 0x28ce98e76d0>
```
## 案例

```python
# df = sns.load_dataset("brain_networks", header=[0, 1, 2], index_col=0)
df = pd.read_csv("brain_networks.csv", header=[0, 1, 2], index_col=0)

# Select a subset of the networks
used_networks = [1, 5, 6, 7, 8, 12, 13, 17]
used_columns = (df.columns.get_level_values("network")
                          .astype(int)
                          .isin(used_networks))
df = df.loc[:, used_columns]
df

```
```
network           1                     5                     6             \
node              1                     1                     1              
hemi             lh         rh         lh         rh         lh         rh   
0         56.055744  92.031036 -35.898861  -1.889181   5.898688 -43.692322   
1         55.547253  43.690075  19.568010  15.902983 -23.231823 -10.745867   
2         60.997768  63.438793  19.247454  37.209419   2.392153  16.509109   
3         18.514868  12.657158  32.896915  11.199619 -14.665752   2.073715   
4         -2.527392 -63.104668  18.396759   3.219077 -41.856911 -24.690414   
..              ...        ...        ...        ...        ...        ...   
915       -7.429513  -4.813219   0.017912 -25.305094 -75.461159 -70.289261   
916      -33.554138 -38.605621 -32.935612 -21.783203 -16.198238 -34.893780   
917      -78.539566 -74.197189 -32.800556 -37.021500   2.098941 -18.581594   
918     -103.235825 -98.744286 -14.330512 -17.224781  -3.007454 -42.672840   
919      -36.288868 -10.762070  26.558777  21.377319   9.652065  12.693388   

network                                7             ...         13  \
node             2                     1             ...          2   
hemi            lh         rh         lh         rh  ...         rh   
0       -47.664265  12.284122   1.566538 -13.042585  ...  14.738475   
1        10.269546  31.275831 -26.309488 -18.077026  ...  23.792282   
2        -5.314236   2.372976  -7.342168 -24.550989  ...   8.968520   
3        32.634335  45.825409 -47.632999  -6.580215  ...  19.627728   
4       -33.975418 -24.149668  -6.315651 -29.344135  ...  55.853088   
..             ...        ...        ...        ...  ...        ...   
915     -13.119029  -5.194376 -56.022263 -24.290606  ... -19.436220   
916      16.504656  13.005379  26.230785   4.764211  ...  16.711153   
917      11.386637   3.676295  52.871113  -3.970096  ...  45.261150   
918       1.581095 -38.023777  37.736561   4.872248  ...  33.483253   
919     -24.773617 -62.247086  -4.883728 -49.077343  ...  -8.466401   

network                               17                                   \
node             3          4          1                     2              
hemi            rh         rh         lh         rh         lh         rh   
0       -16.853010 -34.217819 -21.734550   1.028253   7.791784  68.903725   
1         8.927007 -19.732401 -13.035799  46.381824 -15.752450  31.000332   
2         1.413584  -4.955075  26.033442  34.212200   1.326110 -22.580757   
3        49.208748   1.661293  55.297466   4.255006  -2.420144  12.098393   
4        46.737320   4.586625  43.067562  52.219875  28.232882 -11.719750   
..             ...        ...        ...        ...        ...        ...   
915      15.894722  22.195951  76.179489  51.934669  -6.614513  -6.690762   
916      17.339653  13.682954  50.962399  13.696922  63.503616  57.401176   
917      37.007389  29.753304  43.800747   8.144480  47.281460  70.499649   
918      37.434860 -14.403917  46.674419  40.954796   0.877180  37.577152   
919      23.855883  48.888733 -12.229620  -6.596726  17.665163  16.153173   

network                                    
node             3                      4  
hemi            lh          rh         lh  
0       -10.520872  120.490463 -39.686432  
1       -39.607521   24.764011 -36.771008  
2        12.985169  -75.027451   6.434262  
3       -15.819172  -37.361431  -4.650954  
4         5.453649    5.169828  87.809135  
..             ...         ...        ...  
915      22.893030   48.274380  76.228455  
916      24.974548   51.972153  64.538788  
917      66.994400   81.539246  64.969772  
918      20.517746    3.124434  56.718388  
919       8.300399   33.687531  17.960655  

[920 rows x 38 columns]
```

```python
# Create a categorical palette to identify the networks
network_pal = sns.husl_palette(8, s=.45)
network_lut = dict(zip(map(str, used_networks), network_pal))

# Convert the palette to vectors that will be drawn on the side of the matrix
networks = df.columns.get_level_values("network")
network_colors = pd.Series(networks, index=df.columns).map(network_lut)

# Draw the full plot
sns.clustermap(df.corr(), center=0, cmap="vlag",
               row_colors=network_colors, col_colors=network_colors,
               linewidths=.75, figsize=(7, 7))

```
```
<seaborn.matrix.ClusterGrid at 0x28ce96a2520>
```

```python

```
